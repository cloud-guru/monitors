<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Hoa Ngo">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>usecase-2 - cloud-monitor</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "usecase-2";
    var mkdocs_page_input_path = "usecase/usecase2.md";
    var mkdocs_page_url = "/monitors/usecase/usecase2/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/django.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> cloud-monitor</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Index</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">INTRODUCTION</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../issue/readme/">Issue describe</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">TECHNOLOGY DETAIL</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../tech_detail/vitrage/vitrage-doc/architecture/">vitrage</a>
                </li>
                <li class="">
                    
    <a class="" href="../../tech_detail/mistral/mistral-doc/readme/">mistral</a>
                </li>
                <li class="">
                    
    <a class="" href="../../tech_detail/zabbix/zabbix-doc/readme/">zabbix</a>
                </li>
                <li class="">
                    
    <a class="" href="../../tech_detail/tick/tick-doc/readme/">TICK</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">SCENARIO</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../usecase1/">usecase-1</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">usecase-2</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#noi-dung-kich-ban">Nội dung kịch bản</a></li>
    

    <li class="toctree-l3"><a href="#thuc-hien">Thực hiện</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#chuan-bi-monitor-cac-thanh-phan">Chuẩn bị monitor các thành phần:</a></li>
        
            <li><a class="toctree-l4" href="#cau-hinh-vitrage">Cấu hình vitrage</a></li>
        
            <li><a class="toctree-l4" href="#cau-hinh-mistral">Cấu hình mistral</a></li>
        
            <li><a class="toctree-l4" href="#ket-qua">Kết quả</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">BLUEPRINT</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../issue/propose/readme/">Propose</a>
                </li>
                <li class="">
                    
    <a class="" href="../../issue/start/readme/">Start</a>
                </li>
                <li class="">
                    
    <a class="" href="../../issue/in_process/readme/">In process</a>
                </li>
                <li class="">
                    
    <a class="" href="../../issue/need_review/readme/">Need review</a>
                </li>
                <li class="">
                    
    <a class="" href="../../issue/sloved/readme/">Sloved</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">ABOUT</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../about/release-notes/">Release Notes</a>
                </li>
                <li class="">
                    
    <a class="" href="../../about/contributing/">Contributing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../about/license/">License</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">cloud-monitor</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>SCENARIO &raquo;</li>
        
      
    
    <li>usecase-2</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="noi-dung-kich-ban">Nội dung kịch bản<a class="headerlink" href="#noi-dung-kich-ban" title="Permanent link">&para;</a></h1>
<p>Đầu vào monitor:</p>
<ul>
<li>Nic của host (qua TICK, prometheus, zabbix,..)</li>
<li>Kết nối đến máy ảo. (vd ping đến máy đó)</li>
</ul>
<p>Kịch bản: xuất hiện các alarm</p>
<ul>
<li>
<p>Alarm 1: nic host mất kết nối : nic_operstate {host= compute01, interface = ens8}= 0</p>
</li>
<li>
<p>Alarm 2: Máy ảo mất kết nối (có thể do vitrage tự deduce ra, hoặc monitor tool phát hiện)</p>
</li>
</ul>
<p>Yêu cầu:</p>
<ul>
<li>
<p>Collect được alarm khi xảy ra</p>
</li>
<li>
<p>Vitrage nhân định Alarm 1 =&gt; Alarm 2</p>
</li>
<li>
<p>Vitrage gọi đến mistral thực hiện seft healing</p>
</li>
</ul>
<h1 id="thuc-hien">Thực hiện<a class="headerlink" href="#thuc-hien" title="Permanent link">&para;</a></h1>
<h2 id="chuan-bi-monitor-cac-thanh-phan">Chuẩn bị monitor các thành phần:<a class="headerlink" href="#chuan-bi-monitor-cac-thanh-phan" title="Permanent link">&para;</a></h2>
<p>Ở đây cần nic của host. Lựa chọn TICK  lấy alarm.</p>
<ul>
<li>Đầu tiên cần thiết lập cho telegraf lấy được metric host nic down: ta tạo file</li>
</ul>
<div class="admonition note">
<p class="admonition-title">/usr/share/telegraf_check_nic.sh</p>
</div>
<pre><code>#!/bin/sh
#nics=`find /sys/class/net ! -type d | xargs --max-args=2 realpath  | awk -F\/ '/pci/{print $NF}'`
nics=`ip link  | grep &quot;up&quot; | awk -F&quot;: &quot; {'print $2'}  | grep ^e`
hostname=`hostname`
for nic in $nics
do
  operstate=`cat /sys/class/net/$nic/operstate`
  if [ &quot;$operstate&quot; = &quot;up&quot; ]
  then
     field=1
  else
     field=0
  fi
  echo &quot;nic,host=${hostname},interface=${nic} operstate=${field}&quot;
done
</code></pre>

<p>sửa trong file config của telegraf:</p>
<div class="admonition note">
<p class="admonition-title">/etc/telegraf/telegraf.conf</p>
</div>
<pre><code>[[inputs.exec]]
  ## Commands array
  commands = [
    &quot;/usr/share/telegraf_check_nic.sh&quot;,
  ]
  timeout = &quot;5s&quot;
  data_format = &quot;influx&quot;
</code></pre>

<p>Như vậy , telegraf sẽ liên tục gửi về cho influxdb metric định dạng:</p>
<ul>
<li>nic,host=compute01,interface=ens8 operstate= 0 nếu nic ens8 down</li>
<li>
<p>nic,host=compute01,interface=ens8 operstate= 1 nếu nic ens8 up</p>
</li>
<li>
<p>Tiếp theo cần thiết lập cảnh báo kapacitor:
Tạo 1 tick script:</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">/etc/kapacitor/tick_script_nicdown.txt</p>
</div>
<pre><code>dbrp &quot;telegraf&quot;.&quot;autogen&quot;
var db = 'telegraf'
var rp = 'autogen'
var measurement = 'nic'
var groupBy = ['host', 'interface']
var whereFilter = lambda: TRUE
var name = 'nic down'
var idVar = name + '-{{.Group}}'
var message = ' {{ index .Tags &quot;interface&quot; }} down'
var idTag = 'alertID'
var levelTag = 'level'
var messageField = 'message'
var durationField = 'duration'
var outputMeasurement = 'alerts'
var triggerType = 'threshold'
var crit = 1
var data = stream
    |from()
        .database(db)
        .retentionPolicy(rp)
        .measurement(measurement)
        .groupBy(groupBy)
        .where(whereFilter)
    |eval(lambda: &quot;operstate&quot;)
        .as('value')
var trigger = data
    |alert()
        .crit(lambda: &quot;value&quot; &lt; crit)
        .message(message)
        .id(idVar)
        .idTag(idTag)
        .levelTag(levelTag)
        .messageField(messageField)
        .durationField(durationField)
        .stateChangesOnly()
        .exec('/usr/bin/python', '/etc/kapacitor/kapacitor_vitrage.py', 'rabbit://openstack:Welcome123@192.168.77.51')
trigger
    |httpOut('output')
</code></pre>

<p>Import tick_script trên cho kapacitor:</p>
<pre><code>kapacitor define check_nic_down -tick /etc/kapacitor/tick_script_nicdown.txt
kapacitor endnable check_nic_down
</code></pre>

<ul>
<li>Thực hiện cấu hình cho kapacitor trả về alarm được cho vitrage: https://docs.openstack.org/vitrage/latest/contributor/kapacitor-datasource.html</li>
<li>Kết quả sau khi đặt monitor nic xong: thử ip link down ens8:<ul>
<li><img alt="b12" src="../image/usecase2_2.png" /></li>
</ul>
</li>
</ul>
<h2 id="cau-hinh-vitrage">Cấu hình vitrage<a class="headerlink" href="#cau-hinh-vitrage" title="Permanent link">&para;</a></h2>
<ul>
<li>Thêm kịch bản để khi có alarm nic của host down sẽ xác định cho host nào bị ảnh hưởng.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">scenario2-1.yaml</p>
</div>
<pre><code>metadata:
    version: 2
    name: kapacitor host nic alarm to nic alarm
    type: standard
    description: kapacitor host nic alarm to nic alarm
definitions:
    entities:
        - entity:
            category: ALARM
            name.regex: (.ens8) down
            template_id: host_alarm
        - entity:
            category: RESOURCE
            type: host.nic
            template_id: nic
        - entity:
            category: RESOURCE
            type: nova.host
            template_id: host
    relationships:
        - relationship:
            source: host_alarm
            target: host
            relationship_type: on
            template_id : alarm_on_host

        - relationship:
            source: nic
            target: host
            relationship_type: attach
            template_id : nic_attach_host

scenarios:
    - scenario:
        condition: alarm_on_host and nic_attach_host
        actions:
            - action:
               action_type : raise_alarm
               properties:
                  alarm_name: down
                  severity: critical
               action_target:
                  target: nic
</code></pre>

<div class="admonition note">
<p class="admonition-title">scenario2-2.yaml</p>
</div>
<pre><code>metadata:
    version: 2
    name: nic down scenario 
    type: standard
    description: nic down scenario 
definitions:
    entities:
        - entity:
            category: ALARM
            name: down
            template_id: nic_alarm
        - entity:
            category: RESOURCE
            type: neutron.network
            template_id: net
        - entity:
            category: RESOURCE
            type: host.nic
            template_id: nic
        - entity:
            category: RESOURCE
            type: neutron.port
            template_id: port

        - entity:
            category: RESOURCE
            type: nova.instance
            template_id: instance

        - entity:
            category: RESOURCE
            type: nova.host
            template_id: host

        - entity:
            category: ALARM
            name: disconnect
            template_id: instance_alarm


    relationships:
        - relationship:
            source: nic_alarm
            target: nic
            relationship_type: on
            template_id : alarm_on_nic

        - relationship:
            source: nic
            target: net
            relationship_type: provide
            template_id : nic_provide_net

        - relationship:
            source: net
            target: port
            relationship_type: contains 
            template_id : net_contains_port

        - relationship:
            source: port
            target: instance
            relationship_type: attached 
            template_id : port_attached_instance

        - relationship:
            source: host
            target: instance
            relationship_type: contains
            template_id : host_contains_instance

        - relationship:
            source: nic
            target: host
            relationship_type: attach
            template_id : nic_attach_host

        - relationship:
            source: instance_alarm
            target: instance
            relationship_type: on
            template_id : alarm_on_instance



scenarios:
    - scenario:
        condition: alarm_on_nic and nic_provide_net and net_contains_port and port_attached_instance and host_contains_instance and nic_attach_host
        actions:
            - action:
               action_type : raise_alarm
               properties:
                  alarm_name: disconnect
                  severity: critical
               action_target:
                  target: instance
            - action:
               action_type : execute_mistral
               properties:
                  workflow: instance_live_migrate
                  input:
                    instance_id: get_attr(instance, id)
    - scenario:
        condition: alarm_on_nic and host_contains_instance and nic_attach_host and alarm_on_instance
        actions:
            - action:
               action_type : add_causal_relationship
               action_target:
                  source: nic_alarm
                  target: instance_alarm

</code></pre>

<ul>
<li>Chạy lệnh:</li>
</ul>
<pre><code class="bash">$ vitrage template validate --type standard --path /etc/vitrage/templates/scenario2-1.yaml
$ vitrage template add --type standard --path /etc/vitrage/templates/scenario2-1.yaml
$ vitrage template validate --type standard --path /etc/vitrage/templates/scenario2-2.yaml
$ vitrage template add --type standard --path /etc/vitrage/templates/scenario2-2.yaml
</code></pre>

<h2 id="cau-hinh-mistral">Cấu hình mistral<a class="headerlink" href="#cau-hinh-mistral" title="Permanent link">&para;</a></h2>
<p>Thêm workflow instance_live_migrate sau:</p>
<div class="admonition note">
<p class="admonition-title">workflow_live_migrate.yaml</p>
</div>
<pre><code>version: '2.0'
instance_live_migrate:
 type: direct
 input:
   - instance_id
   - notifi_to_email: admin-openstack@yopmail.com
 tasks:
   get_instance_status_before:
     action: nova.servers_get server=&lt;% $.instance_id %&gt;
     publish:
       instance_name: &lt;% task(get_instance_status_before).result.name %&gt;
       status_before: &lt;% task(get_instance_status_before).result.status %&gt;
       host_before: &lt;% task(get_instance_status_before).result[&quot;OS-EXT-SRV-ATTR:host&quot;] %&gt;
     on-success: live_migrate_instance
     on-error: send_error_email

   live_migrate_instance:
      action: nova.servers_live_migrate
      input:
        server: &lt;% $.instance_id %&gt;
        block_migration: False
        disk_over_commit: False
        host:
      retry:
        count: 10
        delay: 30
      on-success: wait_for_instance_migrate
      on-error: send_error_email

   wait_for_instance_migrate:
     action: nova.servers_get server=&lt;% $.instance_id %&gt;
     retry:
       count: 30
       delay: 2
       continue-on: &lt;% task(wait_for_instance_migrate).result.status !=&quot;MIGRATING&quot; %&gt;
     on-success: wait_instance_status_active

   wait_instance_status_active:
     action: nova.servers_get server=&lt;% $.instance_id %&gt;
     retry:
       delay: 10
       count: 30
       continue-on: &lt;% task(wait_instance_status_active).result.status !=&quot;ACTIVE&quot; %&gt;
     on-success: get_instance_status_after

   get_instance_status_after:
     action: nova.servers_get server=&lt;% $.instance_id %&gt;
     publish:
       status_after: &lt;% task(get_instance_status_after).result.status %&gt;
       host_after: &lt;% task(get_instance_status_after).result[&quot;OS-EXT-SRV-ATTR:host&quot;] %&gt;
     on-complete: check_diffrent_host
   check_diffrent_host:
     action: std.noop
     on-complete:
       - send_error_email: &lt;% $.status_before != $.status_after or $.host_before = $.host_after %&gt;

   send_error_email:
     action: std.email
     input:
       to_addrs: [&lt;% $.notifi_to_email %&gt;]
       subject: ERROR live migrate virtual machine
       body: |
        We try to migrate vm &lt;% $.instance_id %&gt; when host have problem
         Please look at mistral workflow &lt;% execution().id %&gt; for more detail
       from_addr: ngohoa211@gmail.com
       smtp_server: smtp.gmail.com
       smtp_password: secret
</code></pre>

<h2 id="ket-qua">Kết quả<a class="headerlink" href="#ket-qua" title="Permanent link">&para;</a></h2>
<ul>
<li>Khi tắt card mạng, đầu tiên, sẽ có vitrage deduce alarm trên máy báo hiệu máy ảo mất kết nối
<img alt="us1" src="../image/usecase2_4.png" /></li>
<li>Sau đó, hệ thống tự động chuyển máy ảo sang host khác</li>
<li><img alt="us17" src="../image/usecase2_5.png" /></li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../issue/propose/readme/" class="btn btn-neutral float-right" title="Propose">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../usecase1/" class="btn btn-neutral" title="usecase-1"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/cloud-monitor/auto_scaling_auto_healing" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../usecase1/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../issue/propose/readme/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
