<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="MkDocs Team">
  <link rel="shortcut icon" href="../../../../img/favicon.ico">
  <title>mistral - auto_scale_heal</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "mistral";
    var mkdocs_page_input_path = "tech_detail/mistral/mistral-doc/readme.md";
    var mkdocs_page_url = "/tech_detail/mistral/mistral-doc/readme/";
  </script>
  
  <script src="../../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/django.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../../.." class="icon icon-home"> auto_scale_heal</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../../../..">Index</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">INTRODUCTION</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../issue/readme/">Issue describe</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">TECHNICAL SOLUTION</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../issue/need_review/auto_healing/">Auto Healing</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">TECHNOLOGY DETAIL</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../vitrage/vitrage-doc/architecture/">vitrage</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">mistral</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#host-evacuate">host evacuate</a></li>
    

    <li class="toctree-l3"><a href="#instance-in-error-state-cant-evacuate">instance in error state can't evacuate</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#instance_live_migrate">instance_live_migrate:</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../../../zabbix/zabbix-doc/readme/">zabbix</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../telemetry/telemetry-doc/readme/">telemetry</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../tick/tick-doc/readme/">TICK</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">SCENARIO</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../usecase/usecase1/">usecase-1</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">BLUEPRINT</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../issue/propose/readme/">Propose</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../issue/start/readme/">Start</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../issue/in_process/readme/">In process</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../issue/need_review/readme/">Need review</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../issue/sloved/readme/">Sloved</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">ABOUT</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../../about/release-notes/">Release Notes</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../about/contributing/">Contributing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../../about/license/">License</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../..">auto_scale_heal</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../..">Docs</a> &raquo;</li>
    
      
        
          <li>TECHNOLOGY DETAIL &raquo;</li>
        
      
    
    <li>mistral</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="host-evacuate">host evacuate<a class="headerlink" href="#host-evacuate" title="Permanent link">&para;</a></h2>
<hr />
<p>version: &lsquo;2.0&rsquo;
host-evacuate:
  type: direct
  input:
    - host_evacuate
  tasks:
    get_service_nova_compute_work:
      wait-before: 3 #time wait nova-compute down confirmed
      action: nova.services_list
      publish:
        nova_compute_work: &lt;% task(get_service_nova_compute_work).result.where($.binary = &ldquo;nova-compute&rdquo;).where($.state = &ldquo;up&rdquo;).host %&gt;
      on-complete: controll_flow</p>
<pre><code>controll_flow:
  action: std.noop
  on-complete:
    - send_error_email_1: &lt;% $.host_evacuate in $.nova_compute_work %&gt; # compute up
    - send_error_email_2: &lt;% not bool($.nova_compute_work) %&gt; # list empty
    - list_vms: &lt;% (not $.host_evacuate in $.nova_compute_work) and bool($.nova_compute_work) %&gt;

send_error_email_1:
  action: std.echo
  input:
    output: "Fail when evacuate host &lt;% $.host_evacuate %&gt; caused by nova-compute on host not down"

send_error_email_2:
  action: std.echo
  input:
    output: "Fail when evacuate host &lt;% $.host_evacuate %&gt; caused by there are no other host compute up"

list_vms:
   action: nova.servers_list
   input:
     search_opts:
       {"host": &lt;% $.host_evacuate %&gt;}
   on-success: evacuate_instances
</code></pre>
<h1 id="instance-in-error-state-cant-evacuate">instance in error state can&rsquo;t evacuate<a class="headerlink" href="#instance-in-error-state-cant-evacuate" title="Permanent link">&para;</a></h1>
<pre><code>evacuate_instances:
   with-items: vm in &lt;% task(list_vms).result.where($.status != "ERROR") %&gt;
   workflow: instance_evacuate
   input :
     instance_id: &lt;% $.vm.id %&gt;

# evacuate_instances:
#    with-items: vm in &lt;% $.vms %&gt;
#    workflow: instance_evacuate
#    input :
#      instance_id: &lt;% $.vm.id %&gt;
#      instance_status_expect: &lt;% $.vm.status %&gt;
</code></pre>
<hr />
<p>instance_evacuate</p>
<hr />
<p>version: &lsquo;2.0&rsquo;
instance_evacuate:
  type: direct
  input:
    - instance_id
  tasks:
    get_instance_status_before:
      action: nova.servers_find id=&lt;% $.instance_id %&gt;
      publish:
        instance_name: &lt;% task(get_instance_status_before).result.name %&gt;
        status_before: &lt;% task(get_instance_status_before).result.status %&gt;
        host_before: &lt;% task(get_instance_status_before).result[&ldquo;OS-EXT-SRV-ATTR:host&rdquo;] %&gt;
      on-success:
        - send_fail_email_0: &lt;% $.status_before = &ldquo;ERROR&rdquo; %&gt;
        - fail: &lt;% $.status_before = &ldquo;ERROR&rdquo; %&gt;
        - evacuate_instance: &lt;% $.status_before != &ldquo;ERROR&rdquo; %&gt;
      on-error: send_fail_email_1</p>
<pre><code>evacuate_instance:
   action: nova.servers_evacuate server=&lt;% $.instance_id %&gt;
   retry:
     delay: 10
     count: 10
   on-success: wait_for_instance_rebuild
   on-error: get_instance_status_after

wait_for_instance_rebuild:
  action: nova.servers_find id=&lt;% $.instance_id %&gt; status="REBUILD"
  retry:
    delay: 2
    count: 30
  on-success: wait_instance_status_active
  on-error: get_instance_status_after

wait_instance_status_active:
  action: nova.servers_find id=&lt;% $.instance_id %&gt; status="ACTIVE"
  retry:
    delay: 10
    count: 30
  on-complete: get_instance_status_after

get_instance_status_after:
  action: nova.servers_find id=&lt;% $.instance_id %&gt;
  publish:
    status_after: &lt;% task(get_instance_status_after).result.status %&gt;
    host_after: &lt;% task(get_instance_status_after).result["OS-EXT-SRV-ATTR:host"] %&gt;
  on-complete: check_status_not_error

check_status_not_error:
  action: std.noop
  on-complete: 
    - check_status_same_as_status_before : &lt;% $.status_after != "ERROR" %&gt;
    - send_fail_email_2: &lt;% $.status_after = "ERROR" %&gt;

check_status_same_as_status_before:
  action: std.noop
  on-complete: 
    - check_diffrent_host : &lt;% $.status_after = $.status_before %&gt;
    - send_fail_email_3: &lt;% $.status_after != $.status_before %&gt;

check_diffrent_host:
  action: std.noop
  on-complete:
    - test_vm: &lt;% $.host_before != $.host_after %&gt;
    - send_fail_email_4: &lt;% $.host_before != $.host_after %&gt;

test_vm:
  workflow: verify_server server=&lt;% $.instance_id %&gt;
  publish:
    instance_pass_test: &lt;% task(test_vm).result.instance_pass_test %&gt;
  on-success: 
    - send_success_email: &lt;% task(test_vm).result.instance_pass_test = true %&gt;
    - send_fail_email_5: &lt;% task(test_vm).result.instance_pass_test = false %&gt;

send_fail_email_0:
  action: std.echo
  input:
    output: |
      Fail when evacuate instance, instance status before workflow is ERROR
      Instance before workflow: [ name: &lt;% $.instance_name %&gt; ; status: &lt;% $.status_before %&gt; ; host: &lt;% $.host_before %&gt; ].

send_fail_email_1:
  action: std.echo
  input:
    output: |
      Fail when evacuate instance, instance not found with id &lt;% $.instance_id %&gt;

send_fail_email_2:
  action: std.echo
  input:
    output: |
      Fail when evacuate instance, instance status after workflow is ERROR
      Instance before workflow: [ name: &lt;% $.instance_name %&gt; ; status: &lt;% $.status_before %&gt; ; host: &lt;% $.host_before %&gt; ].
      Instance after workflow: [ name: &lt;% $.instance_name %&gt; ; status: &lt;% $.status_after %&gt; ; host: &lt;% $.host_after %&gt; ] 
      Workflow id: &lt;% execution().id %&gt;

send_fail_email_3:
  action: std.echo
  input:
    output: |
      Fail when evacuate instance, instance status after workflow is not same as before workflow
      Instance before workflow: [ name: &lt;% $.instance_name %&gt; ; status: &lt;% $.status_before %&gt; ; host: &lt;% $.host_before %&gt; ].
      Instance after workflow: [ name: &lt;% $.instance_name %&gt; ; status: &lt;% $.status_after %&gt; ; host: &lt;% $.host_after %&gt; ] 
      Workflow id: &lt;% execution().id %&gt;

send_fail_email_4:
  action: std.echo
  input:
    output: |
      Fail when evacuate instance, instance after workflow not move to diffrent host
      Instance before workflow: [name: &lt;% $.instance_name %&gt; ; status_before: &lt;% $.status_before %&gt; ; host_before: &lt;% $.host_before %&gt; ].
      Instance after workflow: [ name: &lt;% $.instance_name %&gt; ; status_after: &lt;% $.status_after %&gt; ; host_after: &lt;% $.host_after %&gt; ]
      Instance pass test: false
      Workflow id: &lt;% execution().id %&gt;

send_fail_email_5:
  action: std.echo
  input:
    output: |
      Fail when evacuate instance, instance after workflow 
      Instance before workflow: [name: &lt;% $.instance_name %&gt; ; status_before: &lt;% $.status_before %&gt; ; host_before: &lt;% $.host_before %&gt; ].
      Instance after workflow: [ name: &lt;% $.instance_name %&gt; ; status_after: &lt;% $.status_after %&gt; ; host_after: &lt;% $.host_after %&gt; ]
      Instance pass test: false
      Workflow id: &lt;% execution().id %&gt;


send_success_email:
  action: std.echo
  input:
   output: |
      Success evacuate instance : 
      Instance before workflow: [ name: &lt;% $.instance_name %&gt; ; status_before: &lt;% $.status_before %&gt; ; host_before: &lt;% $.host_before %&gt; ].
      Instance after workflow: [ name: &lt;% $.instance_name %&gt; ; status_after: &lt;% $.status_after %&gt; ; host_after: &lt;% $.host_after %&gt; ]
      Instance pass test: strue
      Workflow id: &lt;% execution().id %&gt;
</code></pre>
<hr />
<h2 id="instance_live_migrate">instance_live_migrate:<a class="headerlink" href="#instance_live_migrate" title="Permanent link">&para;</a></h2>
<p>version: &lsquo;2.0&rsquo;
instance_live_migrate:
  description: migrate VMs
  type: direct
  input:
    - instance_id
    - target_host:
    - block_migration: False
    - disk_over_commit: False
  output:
    old_host: &lt;% $.old_host %&gt;
    new_host: &lt;% $.new_host %&gt;
    instance_work: &lt;% $.instance_work %&gt;
  tasks:
    get_host_contain_instance_before:
      action: nova.servers_find id=&lt;% $.instance_id %&gt;
      publish:
        old_host: &lt;% task(get_host_contain_instance_before).result[&ldquo;OS-EXT-SRV-ATTR:host&rdquo;] %&gt;
      on-success: live_migrate_instance</p>
<pre><code>live_migrate_instance:
   action: nova.servers_live_migrate
   input:
     server: &lt;% $.instance_id %&gt;
     host: &lt;% $.target_host %&gt;
     block_migration: &lt;% $.block_migration %&gt;
     disk_over_commit: &lt;% $.disk_over_commit %&gt;
   retry:
     delay: 10
     count: 10
   on-success: wait_for_instance_migrating

wait_for_instance_migrating:
  action: nova.servers_find id=&lt;% $.instance_id %&gt; status="MIGRATING"
  retry:
    delay: 3
    count: 30
  on-success: wait_for_instance_status_active
  on-error: send_error_email

wait_for_instance_status_active:
  action: nova.servers_find id=&lt;% $.instance_id %&gt; status="ACTIVE"
  retry:
    delay: 10
    count: 30
  on-success: get_host_contain_vm
  on-error: send_error_email

get_host_contain_vm:
  description: get name vm's host
  action: nova.servers_find id=&lt;% $.instance_id %&gt;
  publish:
    new_host: &lt;% task(get_host_contain_vm).result["OS-EXT-SRV-ATTR:host"] %&gt;
  on-success: check_vm_work
  on-error: send_error_email

check_vm_work:
  workflow: verify_server server=&lt;% $.instance_id %&gt;
  publish:
    instance_work: &lt;% task(check_vm_work).result.instance_work %&gt;
  on-success: 
    - send_success_email: &lt;% task(check_vm_work).result.instance_work = true %&gt;
    - send_error_email: &lt;% task(check_vm_work).result.instance_work = false %&gt;

send_error_email:
  action: std.echo output="fail"

send_success_email:
  action: std.echo output="success"
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../zabbix/zabbix-doc/readme/" class="btn btn-neutral float-right" title="zabbix">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../../vitrage/vitrage-doc/architecture/" class="btn btn-neutral" title="vitrage"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/cloud-monitor/auto_scaling_auto_healing" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../../../vitrage/vitrage-doc/architecture/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../../zabbix/zabbix-doc/readme/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../../..';</script>
    <script src="../../../../js/theme.js" defer></script>
      <script src="../../../../search/main.js" defer></script>

</body>
</html>
